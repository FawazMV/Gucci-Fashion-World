<%- include('../userSide/includes/singleAndCart') %>
<section>
  <div id="top">
    <div class="container pt-5 mb-5">
      <div class="page-wrapper">
        <main class="main pt-5 mb-5">
          <div class="page-header text-center" style="background-image: url('/singlePro/assets/images/page-header-bg.jpg')">
            <div class="container">
              <h1 class="page-title">Checkout</h1>
            </div>
          </div>
          <nav aria-label="breadcrumb" class="breadcrumb-nav">
            <div class="container">
            </div>
          </nav>

          <div class="page-content">
            <div class="dashboard">
              <div class="container">
                <div class="row">

                  <div class="col-md-8 col-lg-8">
                    <div class="tab-content">
                      <div class="" id="tab-address">
                        <% if (address) { %>
                        <div class="row">
                          <div class="col-lg-6">
                            <div class="card card-dashboard">
                              <div class="card-body">
                                <h3 class="card-title">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-geo-alt" viewBox="0 0 20 20">
                                    <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z" />
                                    <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                                  </svg>Delivery Address
                                </h3>
                                <p id="defaultAddressId" class="card-text"><%= address.firstname %> <%= address.lastname %> <br><%= address.address %> <br><%= address.city %>, <%= address.state %> <br> Pin : <%= address.pincode %> <br> Mobile : <%= address.phone %></p>
                                <a onclick="changeaddress()" href="#">Change Address <i class="icon-edit"></i></a>
                                </p>
                              </div>
                            </div>
                          </div>
                          <% } else { %>
                          <div class="col-lg-6">
                            <div class="card card-dashboard">
                              <div class="card-body">
                                <h3 class="card-title">Add Address</h3>
                                <p>You have not added any default address yet<br>
                                  <a class="" onclick="modalOpen()" href="" data-toggle="modal"> <i class="icon-plus"> Add</i></a>
                                </p>
                              </div>
                            </div>
                          </div>
                          <% } %>

                        </div>
                      </div>

                    </div>
                  </div>
                  <aside class="col-lg-3">
                    <div class="summary">
                      <h3 class="summary-title">Your Order</h3><!-- End .summary-title -->

                      <table class="table table-summary">
                        <thead>
                          <tr>
                            <th>Product</th>
                            <th>Total</th>
                          </tr>
                        </thead>

                        <tbody>
                          <tr>
                            <% for( let i=0; i < cartproduct.length; i++ ) { %>
                            <td><a href="#"></a><%= cartproduct[i].product_id.brandName.brandName %></td>
                            <td>₹ <%= cartproduct[i].product_id.shopPrice %>.00</td>
                            <% } %>
                          </tr>
                          <tr class="summary-subtotal">
                            <td>Subtotal:</td>
                            <td>₹ <%- total %>.00 </td>
                          </tr><!-- End .summary-subtotal -->
                          <tr>
                            <td>Coupen Savings:</td>
                            <td>- ₹ <%= discount %> .00</td>
                          </tr>
                          <tr class="summary-total">
                            <td>Total:</td>
                            <td>₹ <%- total %>.00 </td>
                          </tr><!-- End .summary-total -->
                        </tbody>
                      </table><!-- End .table table-summary -->

                      <div class="accordion-summary" id="accordion-payment">
                        <label class="fw-bold">
                          Payment Options
                        </label>
                        <div class="card my-2">
                          <div class="card-header">
                            <div>
                              <label>
                                <input type="radio" name="payment" class="mx-2" value="cod" />Cash
                                on delivery</label>
                            </div>
                          </div>
                        </div>
                        <div class="card my-2">
                          <div class="card-header">
                            <div>
                              <label>
                                <input type="radio" class="mx-2" value="online" name="payment" />Online</label>
                            </div>
                          </div>
                        </div>

                        <% if (locals.wallet) { %>
                        <div class="card my-2">
                          <div class="card-header">
                            <div>
                              <label>
                                <input type="radio" class="mx-2" value="wallet" name="payment" />Wallet <span style="font-size:12px;"> ( ₹ <%= wallet %> )</span></label>
                            </div>

                          </div>
                        </div>
                      </div>
                      <% } %>
                      <p class="ml-2 text-danger mb-1" style="display:none;" id="paymentSelect">
                        Please select payment option </p>
                    </div>

                    <button onclick="placeorder()" type="submit" class="btn btn-outline-primary-2 btn-order btn-block">
                      <span class="btn-text">Place Order</span>
                      <span class="btn-hover-text">Place Order</span>
                    </button>
                </div><!-- End .summary -->
                </aside>
              </div>
            </div>

          </div>
      </div>
    </div>
  </div>
  </div>
  </main>
  </div>
  </div>
  </div>

</section>


<!-- add address -->
<div class="modal fade" id="addBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-body">
    <div class="container-fluid">
      <div class="row">

        <div class="col-md-6 ml-auto">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add Address</h5>

                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="px-3">
                  <div class="row">
                    <div class="col-lg-6">
                      <div class="checkout__input">

                        <form id="addFormid" onsubmit="addAddress()">
                          <p>Fist Name<span>*</span></p>
                          <input name="firstname" class="text-dark" onkeydown="return /[a-z]/i.test(event.key)" type="text" required>
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="checkout__input">
                        <p>Last Name<span>*</span></p>
                        <input name="lastname" class="text-dark" onkeydown="return /[a-z]/i.test(event.key)" type="text" required>
                      </div>
                    </div>
                  </div>
                  <div class="checkout__input">
                    <p>Country<span></span></p>
                    <input type="text" name="country" class="text-dark" value="India" disabled>
                  </div>
                  <div class="checkout__input">
                    <p>Address<span>*</span></p>
                    <textarea name="address" id="" class="text-dark" required style="width:90%;" rows="3"></textarea>
                  </div>
                  <div class="checkout__input">
                    <p>Town/City<span>*</span></p>
                    <input name="city" class="text-dark" onkeydown="return /[a-z]/i.test(event.key)" required type="text">
                  </div>
                  <div class="checkout__input">
                    <p>State<span>*</span></p>
                    <input name="state" class="text-dark" onkeydown="return /[a-z]/i.test(event.key)" required type="text">
                  </div>

                  <div class="row">
                    <div class="col-lg-5">
                      <div class="checkout__input">
                        <p>Pincode<span>*</span></p>
                        <input name="pincode" class="text-dark" onkeypress="return isNumberKey(event)" required type="text">
                      </div>
                    </div>
                    <div class="col-lg-7">
                      <div class="checkout__input">
                        <p>Phone<span>*</span></p>
                        <input name="phone" class="text-dark" onkeypress="return isNumberKey(event)" required type="text">
                      </div>
                    </div>

                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" id="addButton" class="btn btn-secondary" onclick="modalclose('addBackdrop')">Close</button>
                <button type="submit" class="btn btn-primary">Add</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- address show modal -->
<div class="modal fade" id="addressShowmodal" role="dialog" tabindex="-1" aria-labelledby="addressShowmodalLabel" aria-hidden="true">
  <div class="modal-body">
    <div class="container-fluid">
      <div class="row">

        <div class="col-md-6 ml-auto">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Change Address</h5>
                <button type="button" class="btn btn-link p-0 fw-bold" onclick="newfucntion()"> Add address
                </button>
              </div>
              <div class="modal-body">
                <div class="p-3" id="addressshow">
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" id="changeAddressbtnclose" class="btn btn-secondary" onclick="modalclose('addressShowmodal')">Close</button>
                <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-body">
    <div class="container-fluid">
      <div class="row">

        <div class="col-md-6 ml-auto">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Edit Address</h5>

                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="px-3">
                  <div class="row">
                    <div class="col-lg-6">
                      <div class="checkout__input">

                        <form onsubmit="updateAddress()">
                          <p>Fist Name<span>*</span></p>
                          <input name="firstname" class="text-dark" id="firstnameId" onkeydown="return /[a-z]/i.test(event.key)" type="text" required>
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="checkout__input">
                        <p>Last Name<span>*</span></p>
                        <input name="lastname" class="text-dark" id="lastnameId" onkeydown="return /[a-z]/i.test(event.key)" type="text" required>
                      </div>
                    </div>
                  </div>
                  <div class="checkout__input">
                    <p>Country<span></span></p>
                    <input type="text" name="country" class="text-dark" value="India" disabled>
                  </div>
                  <div class="checkout__input">
                    <p>Address<span>*</span></p>
                    <textarea name="address" id="addressId" class=" text-dark" required style="width:90%;" rows="3"></textarea>
                  </div>
                  <div class="checkout__input">
                    <p>Town/City<span>*</span></p>
                    <input name="city" id="cityId" class="text-dark" onkeydown="return /[a-z]/i.test(event.key)" required type="text">
                  </div>
                  <div class="checkout__input">
                    <p>State<span>*</span></p>
                    <input name="state" id="stateId" class="text-dark" onkeydown="return /[a-z]/i.test(event.key)" required type="text">
                  </div>

                  <div class="row">
                    <div class="col-lg-5">
                      <div class="checkout__input">
                        <p>Pincode<span>*</span></p>
                        <input name="pincode" id="pincodeid" class="text-dark" onkeypress="return isNumberKey(event)" required type="text">
                      </div>
                    </div>
                    <div class="col-lg-7">
                      <div class="checkout__input">
                        <p>Phone<span>*</span></p>
                        <input name="phone" class="text-dark" id="phoneid" onkeypress="return isNumberKey(event)" required type="text">
                      </div>
                    </div>
                    <input type="text" name="id" id="idsid" style="display:none;">
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="modalclose('staticBackdrop')">Close</button>
                <button type="submit" class="btn btn-primary">Update</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- Modal -->
<div class="modal fade" id="mobileChange" tabindex="-1" role="dialog" aria-labelledby="mobileChangeTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Change Mobile Numbe</h5>
        <button type="button" class="close" onclick="modalclose('mobileChange')">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="px-5 ml-4 mt-3">
          <label>Mobile Number *</label>
          <div class="d-flex">
            <input type="text" id="newNumber" onkeypress="return isNumberKey(event)" class="form-control" required> <a onclick="newNumber()" style="font-size:18px;position:relative;left:-120px;top:4px;" class="fw-bold ml-2"><span>Send</span><span>OTP</span></a>
          </div>
          <div class="row">
            <div class="col-sm-6">
              <label>OTP</label>
              <input type="text" disabled id="otpclm" onkeypress="return isNumberKey(event)" class="form-control" required>
            </div>

            <div class="col-sm-4">
              <div style="margin-top:37px;">
                <button type="button" id="otpId" disabled onclick="otpconfirm()" class="btn btn-secondary px-4">Confirm</button>
              </div>
            </div>
          </div>
          <p class="text-danger" id="errormsg"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary" onclick="modalclose('mobileChange')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 1500,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener('mouseenter', Swal.stopTimer)
      toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
  })


  function newfucntion() {
    $('#addressShowmodal').modal('hide')
    $('#addBackdrop').modal('show')
  }

  function modalclose(id) {
    $('#' + id).modal('hide')
  }

  function modalOpen() {
    $('#addressShowmodal').modal('show')
  }

  function changeaddress() {
    try {
      axios.get('/getAddress').then(e => {
        if (e.data.response) {
          document.getElementById('addressshow').innerHTML = e.data.response
        } else {
          let address = e.data.address
          let div = ``
          for (let i = 0; i < address.length; i++) {
            div += ` <div class="mt-2" id="deleteDiv${address[i]._id}">`
            if (!address[i].default) {

              div += `<a onclick="deleteAddress('${address[i]._id}')"> <span class="float-end"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
        <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" />
      </svg> </span> </a>`
            }
            div +=
              `
  <h6 class="fw-bold">${address[i].firstname} ${address[i].lastname}</h6>
  <p style="opacity:70%;">${address[i].address}
    <br> ${address[i].city}, ${address[i].state} <br>
    India - ${address[i].pincode} <br>
    Phone : ${address[i].phone}
  </p>
  <div class="d-flex justify-content-between">`
            if (address[i].default) {
              div += ` <button onclick="select('${address[i]._id}')" class="btn btn-success" disabled>Selected</button>`
            } else {

              div += ` <button data-dismiss="modal" onclick="select('${address[i]._id}')" class="btn btn-warning">Select</button>`
            }
            div += `
    <button type="button" class="btn btn-link pl-0 fw-bold float-end" <span class="text-black" style="opacity:70%;"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-vector-pen" viewBox="0 0 18 18">
        <path fill-rule="evenodd" d="M10.646.646a.5.5 0 0 1 .708 0l4 4a.5.5 0 0 1 0 .708l-1.902 1.902-.829 3.313a1.5 1.5 0 0 1-1.024 1.073L1.254 14.746 4.358 4.4A1.5 1.5 0 0 1 5.43 3.377l3.313-.828L10.646.646zm-1.8 2.908-3.173.793a.5.5 0 0 0-.358.342l-2.57 8.565 8.567-2.57a.5.5 0 0 0 .34-.357l.794-3.174-3.6-3.6z" />
        <path fill-rule="evenodd" d="M2.832 13.228 8 9a1 1 0 1 0-1-1l-4.228 5.168-.026.086.086-.026z" />
      </svg></span>
      <span style="opacity:80%;" onclick="editaddress('${address[i]._id}')" class="text-black"> Edit </span>
    </button>
  </div>
  </div>

  <hr>`
          }

          document.getElementById('addressshow').innerHTML = div
          $('#addressShowmodal').modal('show')
        }

      })

    } catch (error) {

    }
  }




  addAddress = async () => {
    $('#addBackdrop').modal('hide')
    event.preventDefault();
    const formData = new FormData(event.target);
    const formProps = await Object.fromEntries(formData);
    try {
      axios.post('/addAddress', formProps).then(e => {
        if (e.data.response === "login") location.href = "/login"
        else if (e.data.response) {
          alert(e.data.response)
          console.log('error')
        } else {
          document.getElementById('addFormid').reset()
          changeaddress()
        }
      })
    } catch (error) {

    }
  }


  updateAddress = async () => {
    event.preventDefault();
    const formData = new FormData(event.target);
    const formProps = await Object.fromEntries(formData);
    try {
      axios.post('/updateAddress', formProps).then(e => {
        if (e.data.response === "login") location.href = "/login"
        else if (e.data.response) {} else {
          $('#staticBackdrop').modal('hide')
          changeaddress()
        }
      })
    } catch (error) {}
  }

  function deleteAddress(id) {
    axios.patch('/deleteAddress', {
      id: id
    }).then(() => {
      document.getElementById('deleteDiv' + id).style.display = 'none'
    })
  }

  function editaddress(id) {
    $('#addressShowmodal').modal('hide')
    axios.get('/getEditAddress', {
      params: {
        id: id
      }
    }).then(e => {
      let address = e.data.address
      document.getElementById('firstnameId').value = address.firstname
      document.getElementById('lastnameId').value = address.lastname
      document.getElementById('addressId').value = address.address
      document.getElementById('cityId').value = address.city
      document.getElementById('stateId').value = address.state
      document.getElementById('pincodeid').value = address.pincode
      document.getElementById('phoneid').value = address.phone
      document.getElementById('idsid').value = address._id
      $('#staticBackdrop').modal('show')
    })
  }



  function select(id) {
    axios.put('/default', {
      id: id
    }).then(e => {
      if (e.data.response === "login") location.href = "/login"
      else if (e.response) {
        Swal.fire({
          icon: 'error',
          title: 'Oops....!',
          text: 'Something went wrong!',
        })
      } else {
        let address = e.data.address.address
        document.getElementById('defaultAddressId').innerHTML = `${ address[0].firstname } ${ address[0].lastname } <br>${ address[0].address } <br>${ address[0].city }, ${ address[0].state } <br> Pin : ${ address[0].pincode } <br> Mobile : ${ address[0].phone }`
        $('#addressShowmodal').modal('hide')
      }
    })
  }

  function isNumberKey(evt) {
    var charCode = (evt.which) ? evt.which : evt.keyCode
    if (charCode > 31 && (charCode < 48 || charCode > 57))
      return false;
    return true;
  }
</script>





<script>
  placeorder = () => {
    let check = document.getElementsByName('payment')
    let payment
    if (check[0].checked || check[1].checked || check[2]?.checked) {
      for (i = 0; i < check.length; i++) {
        if (check[i].checked) payment = check[i].value;
      }
      try {
        axios.put('/placeOrder', {
          payment: payment
        }).then(async (e) => {
          if (e.data.response === "login") location.href = "/login"
          else if (e.data.addreserrr) {
            const Toast = Swal.mixin({
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 2000,
              timerProgressBar: true,
              didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
              }
            })

            Toast.fire({
              icon: 'warning',
              title: 'Please add a delivery address'
            })
          } else if (e.data.response === "cod" || e.data.response === "Wallet") location.href = '/success'
          else {
            let response = await e.data.response
            razorpayPayment(response)
          }
        })
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Oops..!',
          text: 'Something went wrong',
        })
      }
    } else {
      document.getElementById('paymentSelect').style.display = "block"
    }
  }
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  function razorpayPayment(order) {
    var options = {
      "key": "rzp_test_L6hqBtE36n6FQQ",
      "amount": order.amount,
      "currency": "INR",
      "name": "HEXASHOP",
      "description": "Test Transaction",
      "image": "/assets/images/logo.png",
      "order_id": order.id,
      "handler": function(response) {
        verifyPayment(response, order.receipt, order.amount, order.wallet)
      }
    };
    var rzp1 = new Razorpay(options);
    rzp1.open();
    e.preventDefault();
    rzp1.on('payment.failed', function(response) {
      Swal.fire({
        icon: 'error',
        title: 'Payment Failed',
        text: response.error.reason,
      })
    });
  }


  verifyPayment = (payment, orderId, amount, wallet) => {
    try {
      axios.post('/verifyPayment', {
        payment: payment,
        orderId: orderId,
        amount: amount,
        wallet: wallet
      }).then(e => {
        if (e.data.response === "login") location.href = "/login"
        else if (e.data.status) location.href = "/success"
        else {
          Swal.fire({
            icon: 'error',
            title: 'Payment Failed',
            text: 'Something went wrong!',
          })
        }
      })
    } catch (error) {
      console.log(error)
    }
  }
</script>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
</head>
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
<!-- Css Styles -->
<link rel="stylesheet" href="/user/assets/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="/user/assets/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="/user/assets/css/elegant-icons.css" type="text/css">
<link rel="stylesheet" href="/user/assets/css/magnific-popup.css" type="text/css">
<link rel="stylesheet" href="/user/assets/css/nice-select.css" type="text/css">
<link rel="stylesheet" href="/user/assets/css/owl.carousel.min.css" type="text/css">
<link rel="stylesheet" href="/user/assets/css/slicknav.min.css" type="text/css">
<link rel="stylesheet" href="/user/assets/css/style.css" type="text/css">


<!-- ***** Main Banner Area Start ***** -->

<div id="top">
  <div class="contain pt-5 mb-5">
    <div class="page-wrapper">
      <main class="main pt-5 mb-5">
        <div class="page-content">
          <div class="container">


            <section class="breadcrumb-option" style="background-image: url('/singlePro/assets/images/page-header-bg.jpg')">
              <div class="container">
                <div class="row">
                  <div class="col-lg-12 text-center">
                    <div class="breadcrumb__text">
                      <h3 class="fw-bold">Shopping Cart</h3>
                    </div>
                  </div>
                </div>
              </div>

            </section>


            <div class="alert alert-warning mt-2 mb-0 text-center" id="alertBox" style="display:none;" role="alert">
              Remove out of stock items to checkout ! ! !
            </div>
            <section class="shopping-cart spad ">


              <div class="container">

                <% if (cartproduct.length) { %>

                <div class="row">
                  <div class="col-lg-8">
                    <div class="shopping__cart__table">

                      <table>
                        <thead>
                          <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody>
                          <% for( let i=0; i < cartproduct.length; i++ ) { %>

                          <tr>

                            <td class="product__cart__item">


                              <div class="product__cart__item__pic">
                                <% if (cartproduct[i].product_id.quantity==0) { %>
                                <span class="badge badge-danger me-3" style="position:absolute;margin-top:30px;left: 8px; z-index:1;">Out
                                  of
                                  stock</span>
                                <% } %>

                                <a href="/singelProduct/<%= cartproduct[i].product_id._id %>"> <img src="<%= cartproduct[i].product_id.imagesDetails[0].Location %> " style="width:65px; position: relative;" alt=""></a>
                              </div>
                              <div class="product__cart__item__text">
                                <h6>
                                  <%= cartproduct[i].product_id.brandName.brandName
                                                                                %>
                                </h6>
                                <h5>₹<span id="price<%= cartproduct[i]._id %>">
                                    <%= cartproduct[i].product_id.shopPrice
                                                                                    %>
                                  </span>
                                </h5>
                              </div>
                            </td>
                            <td class="quantity__item">

                              <div class="input-group quantity mx-auto" style="width: 100px;">
                                <div class="input-group-btn">
                                  <button id="minusbutton<%= cartproduct[i]._id %>" onclick="quantityminus('<%= cartproduct[i]._id %>','<%= cartproduct[i].product_id._id %>')" class="btn btn-sm btn-primary btn-minus">
                                    <i class="fa fa-minus"></i>
                                  </button>
                                </div>
                                <input type="text" class="form-control form-control-sm border-0 text-center" name="quantity" value="<%= cartproduct[i].quantity %>" id="quantity<%= cartproduct[i]._id %>">
                                <div class="input-group-btn">
                                  <button class="btn btn-sm btn-primary btn-plus" id="plusButton<%= cartproduct[i]._id %>" onclick="quantityPlus('<%= cartproduct[i]._id %>','<%= cartproduct[i].product_id._id %>')">
                                    <i class="fa fa-plus"></i>
                                  </button>
                                </div>
                              </div>
                            </td>
                            <td class="cart__price" id="totalPrice<%= cartproduct[i]._id %>"></td>
                            <td class="cart__close"><a onclick="cartDelete('<%= cartproduct[i]._id %>')"><i class="fa fa-close"></i></a>
                            </td>

                          </tr>
                          <script>
                            if (document.getElementById('quantity<%= cartproduct[i]._id %>').value == 1) {
                              document.querySelector('#minusbutton<%= cartproduct[i]._id %>').disabled = true;
                            }
                            document.getElementById('totalPrice<%= cartproduct[i]._id %>').innerHTML = document.getElementById('price<%= cartproduct[i]._id %>').innerHTML * document.getElementById('quantity<%= cartproduct[i]._id %>').value
                          </script>
                          <% } %>


                        </tbody>
                      </table>


                    </div>
                    <div class="row">
                      <div class="col-lg-6 col-md-6 col-sm-6">
                        <div class="continue__btn">
                          <a href="#">Continue Shopping</a>
                        </div>
                      </div>
                      <!-- <div class="col-lg-6 col-md-6 col-sm-6">
                                                <div class="continue__btn update__btn">
                                                    <a href="#" type="submit" ><i class="fa fa-spinner"></i>  Update cart</a>
                                                </div>
                                            </div> -->
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="cart__discount">
                      <h6>Discount codes</h6>
                      <form>
                        <input id="coupenCodeId" type="text" placeholder="Coupon code">
                        <button onclick="coupenApply()" type="button">Apply</button>
                      </form>
                    </div>
                    <div class="cart__total">
                      <h6>Cart total</h6>
                      <ul style="letter-spacing:1.2px;">
                        <li>Subtotal <span>₹ <span id="subTotalId"> <%- locals.total %>.00 </span></span></li>
                        <li>Coupen discounts <span>- ₹ <span id="coupendiscount"> 00.00 </span></span></li>
                        <hr style="height:1px;border:none;color:#333;background-color:#333;" />
                        <li class="fw-bold">Total <span> ₹ <span id="totalId"> <%- locals.total %>.00
                            </span></span></li>
                      </ul>
                      <button class="btn btn-link" id="checkoutId" style="text-decoration:none;"> <a onclick="checkout()" class="primary-btn btn btn-dark text-white ">Proceed to checkout</a></button>
                    </div>
                  </div>
                </div>
                <% } else { %>
                <div class="row">
                  <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="continue__btn update__btn">
                      <h4 class="text-primary text-center mt-2" style="opacity:50%;">
                        Ohoo... Your
                        cart is empty !!</h4>
                    </div>
                  </div>
                  <div class="col-lg-6 col-md-6 col-sm-6 ">
                    <div class="continue__btn me-5">
                      <a href="/">Continue Shopping</a>
                    </div>
                  </div>

                </div>
                <% } %>
              </div>
            </section>


          </div><!-- End .container -->
        </div><!-- End .page-content -->
      </main><!-- End .main -->
    </div>
  </div>
</div>
<% for( let i=0; i < cartproduct.length; i++ ) { %>
<% if (cartproduct[i].product_id.quantity==0) { %>
<script>
  document.getElementById('checkoutId').disabled = true
  document.getElementById('alertBox').style.display = "block"
</script>
<% } %>
<% } %>


<script>
  let coupencode
  coupenApply = () => {
    coupencode = document.getElementById('coupenCodeId').value
    if (!coupencode == "") {
      axios.put('/coupenApply', {
        code: coupencode
      }).then((e) => {
        const Toast = Swal.mixin({
          toast: true,
          position: 'center-end',
          showConfirmButton: false,
          timer: 1000,
          timerProgressBar: true,
          didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
          }
        })
        if (e.data.coupenStatus) {
          document.getElementById('coupendiscount').innerHTML = e.data.discout + ".00"
          document.getElementById('totalId').innerHTML = e.data.subtotal + ".00"

          Toast.fire({
            icon: 'success',
            title: 'Your coupen applied successfully'
          })
        } else {
          Toast.fire({
            icon: 'error',
            title: e.data.response
          })
        }
      })
    }
  }




  function quantityPlus(id, product) {
    document.getElementById('coupenCodeId').value = ''
    document.getElementById('coupendiscount').innerHTML = "00.00"
    count = ++document.getElementById('quantity' + id).value
    axios.post('/quantityPlus', {
      id: product,
      count: count,
      cartid: id
    }).then((e) => {

      if (e.data.response === "login") location.href = "/login"
      else if (e.data.response) {
        document.getElementById('totalPrice' + id).innerHTML = document.getElementById('price' + id).innerHTML * count
        document.getElementById('subTotalId').innerHTML = e.data.total + ".00"
        document.getElementById('totalId').innerHTML = e.data.total + ".00"
        document.querySelector('#minusbutton' + id).disabled = false;
      } else {
        document.getElementById('quantity' + id).value--
        Swal.fire({
          icon: 'error',
          title: 'Sorry',
          text: 'Prodcut is out of stock,'
        })
        document.querySelector('#plusButton' + id).disabled = true;
      }
    })



  }

  function quantityminus(id, product) {
    document.getElementById('coupenCodeId').value = ''
    document.getElementById('coupendiscount').innerHTML = "00.00"
    document.querySelector('#plusButton' + id).disabled = false;
    count = --document.getElementById('quantity' + id).value
    if (count < 1) {
      document.querySelector('#minusbutton' + id).disabled = true;
      ++document.getElementById('quantity' + id).value
    } else {
      document.getElementById('totalPrice' + id).innerHTML = document.getElementById('price' + id).innerHTML * count
      axios.post('/quantityPlus', {
        id: product,
        count: count,
        cartid: id
      }).then(e => {
        if (e.data.response === 'login') location.href = "/login"
        else {
          document.getElementById('subTotalId').innerHTML = e.data.total + ".00"
          document.getElementById('totalId').innerHTML = e.data.total + ".00"
        }
      })
    }
  }

  function cartDelete(id) {
    axios.post('/cartDelete', {
      id: id
    }).then((e) => {
      if (e.data.response === "login") location.href = "/login"
      else location.reload()
    })
  }

  checkout = () => {
    axios.patch('/coupenSave', {
      code: coupencode
    }).then((e) => {
      if (e.data.response === "login") location.href = "/login"
      else location.href = "/checkout"
    })
  }
</script>


<!-- <script src="/user/assets/js/bootstrap.min.js"></script> -->
<script src="/user/assets/js/jquery.nice-select.min.js"></script>
<script src="/user/assets/js/jquery.nicescroll.min.js"></script>
<script src="/user/assets/js/jquery.magnific-popup.min.js"></script>
<script src="/user/assets/js/jquery.countdown.min.js"></script>
<script src="/user/assets/js/jquery.slicknav.js"></script>
<script src="/user/assets/js/mixitup.min.js"></script>
<script src="/user/assets/js/owl.carousel.min.js"></script>
<script src="/user/assets/js/main.js"></script>